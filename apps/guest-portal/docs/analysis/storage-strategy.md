# パスポート画像のストレージ戦略 (Storage Strategy for Passport Images)

「自前サーバー(VPS)の容量圧迫を避けるため、画像をどこに保存すべきか」という課題に対する比較・分析です。

## 比較表 (Comparison)

| 特徴 | Google Drive API | Object Storage (R2/S3) | VPS Local Storage |
| :--- | :--- | :--- | :--- |
| **用途** | 個人向けファイル管理 | **アプリ向けデータ保存** | サーバー内保存 |
| **開発コスト** | **高** (OAuth認証など複雑) | **低** (AWS SDKで簡単) | 低 (ファイル保存のみ) |
| **自動化** | API制限やトークン期限切れ有り | **完全自動化に向いている** | 簡単 |
| **閲覧性** | スタッフがGUIでフォルダを見れる | 管理画面が必要 | サーバーにログインが必要 |
| **コスト** | 無料枠15GB (個人垢) | **10GB無料/月 (R2)**, S3は有料 | サーバー費用に含まれる |
| **容量** | アカウント依存 | **実質無制限** (安い) | サーバー依存 (すぐ一杯になる) |

---

## 案1: Google Drive API (推奨度: 低)
スタッフが普段からGoogle Driveを使っていて、「フォルダを開けばそこに画像が入っている」状態を強く望む場合は選択肢に入ります。

*   **メリット**: スタッフが画像を直接PCで触りやすい（同期アプリ等で）。
*   **デメリット**:
    *   **技術的負債**: Googleの認証フロー（OAuth2）をサーバーに実装する必要があり、トークン更新エラーなどで止まるリスクが高い。
    *   **遅い**: Web表示用としてはレスポンスが遅い。
    *   **API制限**: 大量の画像アップロードで制限に引っかかる可能性がある。

## 案2: Object Storage (Cloudflare R2) (推奨度: 高)
AWS S3互換のストレージサービス。特にCloudflare R2は「下り転送量が無料」で、S3のような複雑な課金体系がないため個人〜小規模開発に最適です。

*   **メリット**:
    *   **安い**: 月10GBまでストレージ無料。転送料も無料。
    *   **標準的**: AWS SDKを使って簡単に実装でき、将来AWS S3への移行も一瞬。
    *   **スケーラブル**: 何万枚保存しても問題なし。
*   **デメリット**:
    *   スタッフが中身を見るには、作った「管理画面」経由で見る必要がある（Google Driveのようにフォルダでは見れない）。

## 案3: VPS Local Storage (推奨度: 中)
XServer VPSのディスクにそのまま保存する。

*   **メリット**: 実装が一番簡単。
*   **デメリット**:
    *   サーバーの容量（例: 50GB）を食いつぶすと、Webサーバー自体が落ちる。
    *   バックアップが面倒（サーバーが壊れたら画像も消える）。
    *   Next.js (Standalone) の場合、再デプロイ時に画像が消える構成になりがち（永続化ボリュームの設定が必要）。

---

## 結論・推奨 (Recommendation)

**Cloudflare R2 (または AWS S3) の利用を強く推奨します。**

*   **理由**: 「容量圧迫の回避」が主目的であれば、容量無制限かつ安価なオブジェクトストレージが正解です。Google Drive APIはシステムとしての安定性に欠け（トークン切れ等）、保守コストが高くなります。
*   **運用**: 管理画面（Staff App）に「パスポート画像を表示するボタン」を作り、そのボタンが R2/S3 のURLを参照するように実装するのが最も標準的でスマートな構成です。

---

## 追記: 「法的な保存（3年間）」が目的の場合の注意点

「めったに見ないが、法律のために確実に保存しておきたい」という場合でも、**Google Drive API の直接利用は推奨しません。**

### なぜ Google Drive API は「保存義務」に向かないのか？
1.  **「静かなる失敗」のリスク (Silent Failure)**:
    *   Googleの認証トークン(OAuth)は、セキュリティ上の理由で切れることがあります。
    *   もしトークンが切れている間にゲストがチェックインすると、**画像アップロードがエラーになり、データが保存されません**。
    *   管理者がそれに気づかず数週間経過した場合、「**法的義務違反（名簿不備）**」の状態が放置されてしまいます。
2.  **Object Storage (R2/S3) の優位性**:
    *   AWS SDK (API Key方式) は、トークン切れのような概念がなく、設定を変えない限り永遠に動き続けます。「**確実に保存する**」信頼性が桁違いです。

### どうしても Google Drive に置きたい場合
もし「いざという時に、警察にフォルダURLを渡すだけで済ませたい」という運用上の強い要望がある場合は、以下の **Hybrid構成** をお勧めします。

1.  **即時保存 (Realtime)**: アプリは信頼性の高い **Cloudflare R2** に画像をアップロードする（失敗リスク低）。
2.  **定期バックアップ (Batch)**: 夜間に1回、サーバーのプログラムが R2 から Google Drive へデータをコピーする。

これなら、もしGoogle連携が失敗しても、R2には確実に原本が残っているため、法律違反のリスクを回避できます。

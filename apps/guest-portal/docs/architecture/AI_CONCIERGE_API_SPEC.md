# AIコンシェルジュ実装ガイド (Frontend向け)

BYODシステム（ゲスト用アプリ）からAIコンシェルジュ機能を利用するためのAPI仕様書です。

## 概要
ゲストがAIコンシェルジュと対話するためのインターフェースを提供します。
バックエンドでは、ゲストの予約情報に基づいて「施設情報」や「過去の会話履歴」を自動的にコンテキストとしてAIに提供するため、フロントエンドは予約IDとメッセージ内容を送信するだけで高度な対話が可能です。

---

## 1. セッションの開始・継続
チャット画面を開いた際、または初回ロード時に以下のAPIをコールしてセッションIDを取得してください。
このAPIは、既存のセッションがあればそれを返し、なければ新規作成します（冪等性のような挙動）。

- **Endpoint**: `POST /api/concierge/sessions/`
- **Request Body**:
  ```json
  {
    "reservation": 123  // 予約ID (Reservation ID)
  }
  ```
- **Response (200 OK or 201 Created)**:
  - `200 OK`: 既存のセッションが見つかり、その履歴を含むデータが返却されます。
  - `201 Created`: 新規セッションが作成され、返却されます。

  **レスポンス例:**
  ```json
  {
    "id": 1,  // セッションID (次のステップで使用)
    "reservation": 123,
    "messages": [
      {
        "id": 1,
        "role": "user",
        "content": "チェックインは何時？",
        "created_at": "2024-01-01T15:00:00Z"
      },
      {
        "id": 2,
        "role": "assistant",
        "content": "15時から可能です。",
        "created_at": "2024-01-01T15:00:05Z"
      }
    ]
  }
  ```

## 2. メッセージの送信 (AIへの質問)
ユーザーがメッセージを入力し、送信ボタンを押した際にコールします。
バックエンド側でRAG（検索）と履歴参照を行い、AIの回答を生成して保存します。

- **Endpoint**: `POST /api/concierge/sessions/{session_id}/ask/`
  - `{session_id}`: 上記「1. セッションの開始」で取得したID
- **Request Body**:
  ```json
  {
    "content": "近くのおすすめレストランは？"
  }
  ```
- **Response (201 Created)**:
  AIからの回答メッセージオブジェクトが返却されます。

  **レスポンス例:**
  ```json
  {
    "id": 3,
    "role": "assistant",
    "content": "近くには『函館ラーメン』という人気店があります。徒歩5分です。",
    "created_at": "2024-01-01T15:05:00Z"
  }
  ```

## 3. UI実装のポイント
- **履歴の表示**: 「1. セッションの開始」のレスポンスに含まれる `messages` 配列を使用して、チャット画面の初期状態を描画してください。
- **ロールによる表示分け**: 
  - `role: "user"` -> ゲストの発言（右側に表示など）
  - `role: "assistant"` -> AIの発言（左側に表示など）
- **ローディング表示**: メッセージ送信API (`ask`) はAI生成待ち時間が発生するため、レスポンスが返るまで「入力中...」等のインジケータを表示することを推奨します。

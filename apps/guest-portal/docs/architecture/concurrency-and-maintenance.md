# 同時アクセスと保守性に関するアーキテクチャ設計 (Architecture for Concurrency & Maintainability)

## 1. 複数人同時アクセス時の挙動 (Concurrency)

### 現状 (Client-Side State)
現在は `Zustand` を用いて、各ユーザーのブラウザ（LocalStorage）内で状態を完結させています。
*   **挙動**: AさんとBさんが同時にサイトにアクセスしても、それぞれのブラウザ内で独立して動くため、**互いに干渉することはありません**。
*   **メリット**: サーバー負荷が低く、非常に高速。
*   **デメリット**: データの共有ができない（例：Aさんがチェックイン完了しても、Bさんの画面では反映されない）。

### 今後のバックエンド連携時 (Server-Side State)
データベース（DB）を導入し、複数人でデータを共有する場合（同じ部屋に泊まるグループ客など）の考慮事項です。

#### A. データの整合性 (Data Consistency)
*   **課題**: グループの代表者Aさんがチェックイン操作中に、同行者Bさんも操作した場合、データが競合する可能性がある。
*   **対策 (Optimistic Locking)**:
    *   Prisma等のORMが持つ「バージョン管理」機能を利用。
    *   更新時に `updatedAt` や `version` カラムを確認し、誰かが先に更新していた場合はエラー（または最新データ再取得）を返す。
*   **対策 (Idempotency)**:
    *   「チェックイン完了API」を何度叩いても、一度完了していれば「成功」と同じ結果を返す（副作用を二重に起こさない）。

#### B. 負荷分散 (Scalability)
*   **Next.js (Serverless)**: Vercel等のEdge/Serverless環境では、アクセス数に応じて自動的にインスタンスがスケールするため、数千人が同時にアクセスしてもサーバーが落ちることは基本的にありません。
*   **DB接続数**: DBへの接続数（Connection Pool）がボトルネックになる可能性があるため、Prisma Data ProxyやSupabase Transaction Pooler (PgBouncer) の利用を検討します。

---

## 2. 保守性の向上 (Maintainability)

「壊れにくく、修正しやすい」システムを維持するための戦略です。

### A. 型安全性 (Strict Type Safety)
*   **End-to-End Type Safety**:
    *   DB (Prisma) から API (tRPC / Next.js Actions) 、フロントエンド (React) まで、**一つの型定義を貫通**させること。
    *   これにより、「DBのカラム名を変えたら、フロントエンドのビルドが自動的に落ちて検知できる」状態を作ります。

### B. コンポーネント設計 (Atomic Design / Compound Components)
*   **Colocation**: 関連するロジック、スタイル、テストを可能な限り近くに置く（現在の `steps/` ディレクトリのような構成を維持・強化）。
*   **Storybook**: 複雑なUI（チェックインステップなど）は、アプリ全体を起動しなくても単体で動作確認できるように、Storybookを導入してカタログ化する。

### C. 自動化テスト (Testing Strategy)
現状は手動確認に依存していますが、以下の自動化が必要です。
1.  **E2Eテスト (Playwright)**:
    *   「トップページを開く → QRスキャン → 情報入力 → 完了」という重要パスを、ロボットが毎日自動で実行して壊れていないか監視する。
2.  **Unitテスト (Jest / Vitest)**:
    *   「料金計算ロジック」など、ビジネスロジックの正しさを保証する。

### D. コード品質の自動化 (Linting & Formatting)
*   **ESLint / Prettier**: 既に導入済みですが、ルールを厳格化（`unused-imports`の禁止、アクセシビリティ対応の強制など）し、個人の癖によるコードのブレを無くします。
*   **Husky**: コミット前に自動でチェックを走らせ、汚いコードがリポジトリに入るのを防ぎます。

## まとめ
*   **同時アクセス**: 現状は問題なし。DB導入時は「楽観的ロック」で整合性を担保。
*   **保守性**: 「型安全性」の徹底と、「E2Eテスト」の導入が次の最重要ステップです。
